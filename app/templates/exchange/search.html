{% extends 'base.html' %}

{% block title %}Обмен жильём — Room2room Tour{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h5 mb-0">Обмен жильём</h1>
  <div class="d-flex gap-2">
    <form method="get" class="d-none d-md-flex" role="search">
      {{ form.q(class_='form-control', placeholder='Поиск по объявлениям...') }}
    </form>
    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="offcanvas" data-bs-target="#filtersCanvas" aria-controls="filtersCanvas">
      <i class="fa fa-filter me-1"></i> Фильтры
    </button>
    {% if current_user.is_authenticated %}
      <a href="{{ url_for('exchange.new_listing') }}" class="btn btn-accent">Создать объявление</a>
    {% endif %}
  </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="filtersCanvas" aria-labelledby="filtersCanvasLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="filtersCanvasLabel">Фильтры</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <form method="get">
      <div class="mb-3">
        <label class="form-label">Поиск</label>
        {{ form.q(class_='form-control', placeholder='Название, описание...') }}
      </div>
      <div class="mb-3">
        <label class="form-label">Город</label>
        {{ form.city(class_='form-control', placeholder='Москва') }}
      </div>
      <div class="mb-3">
        <label class="form-label">Тип</label>
        {{ form.housing_type(class_='form-select') }}
      </div>
      <div class="row g-3">
        <div class="col-6">
          <label class="form-label">Комнат от</label>
          {{ form.rooms_min(class_='form-control') }}
        </div>
        <div class="col-6">
          <label class="form-label">Комнат до</label>
          {{ form.rooms_max(class_='form-control') }}
        </div>
      </div>
      <div class="d-grid mt-3">
        <button class="btn btn-accent" type="submit">Показать</button>
      </div>
    </form>
  </div>
</div>

{% if not listings %}
  <div class="text-muted">Ничего не найдено.</div>
{% else %}
  <div class="list-group shadow-sm">
    {% for item in listings %}
      <a href="{{ url_for('exchange.listing_detail', listing_id=item.id) }}" class="list-group-item list-group-item-action py-3">
        <div class="d-flex gap-3">
          <div class="flex-shrink-0" style="width: 160px;">
            <div class="ratio ratio-4x3 listing-thumb rounded">
              {% set photo = (item.photos[0] if item.photos and item.photos|length > 0 else url_for('static', filename='images/hero-mountains.png')) %}
              <img src="{{ photo|media }}" alt="" class="img-cover rounded">
            </div>
          </div>
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start">
              <h2 class="h6 mb-1 text-dark">{{ item.title }}</h2>
              <span class="badge text-bg-light">{{ item.housing_type or 'Тип' }} · {{ item.room_count or 0 }} комн.</span>
            </div>
            <div class="small text-muted mb-1">{{ item.city or 'Город' }}{% if item.address %}, {{ item.address }}{% endif %}</div>
            {% if item.description %}
              <div class="small text-muted text-truncate-2">{{ item.description }}</div>
            {% endif %}
          </div>
        </div>
      </a>
    {% endfor %}
  </div>
{% endif %}
{% endblock %}


